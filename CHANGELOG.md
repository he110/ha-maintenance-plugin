# Changelog

Все значительные изменения в проекте будут документированы в этом файле.

Формат основан на [Keep a Changelog](https://keepachangelog.com/ru/1.0.0/),
и этот проект придерживается [Semantic Versioning](https://semver.org/spec/v2.0.0.html).

## [2.0.0] - 2025-06-16

### Полная переработка интеграции
- **Чистая реализация с нуля**: Убрана вся проблемная логика, создана простая и надежная версия
- **Упрощенная архитектура**: Только необходимые компоненты без избыточной сложности
- **Стабильные идентификаторы**: Простая логика unique_id без конфликтов
- **Автоматическое обновление**: Ежедневное обновление состояний в полночь

### Основной функционал
- **Добавление компонентов**: Название, интервал обслуживания, опциональная привязка к устройству
- **Два сенсора**: `_status` (ok/due/overdue) и `_days` (дни до обслуживания)
- **Кнопка обслуживания**: Устанавливает текущую дату как дату последнего обслуживания
- **Автоматические обновления**: Состояния актуализируются каждый день в 00:01

### Технические улучшения
- Простая и понятная структура кода
- Надежное хранение и восстановление состояний
- Правильная обработка дат и часовых поясов
- Логирование для отладки

## [1.3.8] - 2025-06-16

### Критическое исправление совместимости
- **Исправлена логика unique_id**: Восстановлена совместимость с существующими сущностями
- **Исправлена инициализация**: Улучшена логика восстановления состояния для новых и существующих записей
- **Стабилизированы идентификаторы**: Возвращена логика создания unique_id на основе имени и entry_id

### Техническая проблема
После изменения логики unique_id все существующие сущности стали показывать ошибку "больше не предоставляется интеграцией".

### Изменения
- Восстановлена оригинальная логика создания unique_id
- Улучшена инициализация last_maintenance для новых записей
- Исправлена логика восстановления состояния

## [1.3.7] - 2025-06-16

### Критическое исправление для новых записей
- **Исправлено создание новых записей**: Добавлена установка даты последнего обслуживания для новых компонентов
- **Улучшена отладка**: Расширено логирование процесса создания кнопок
- **Исправлена инициализация**: Новые записи теперь получают текущую дату как дату последнего обслуживания

### Техническая проблема
Проблема была в том, что новые записи не получали дату последнего обслуживания в config_flow, что приводило к неправильной инициализации сущностей.

### Изменения
- Добавлен `CONF_LAST_MAINTENANCE` в config_flow.py
- Установка `dt_util.now().date()` для новых записей
- Расширенное логирование создания кнопок

## [1.3.6] - 2025-06-16

### Исправления инициализации и доступности
- **Немедленная инициализация**: Сущности теперь сразу записывают состояние при добавлении
- **Исправлена доступность кнопки**: Добавлена немедленная запись состояния для кнопки
- **Улучшена отладка**: Расширено логирование для диагностики проблем с кнопкой
- **Стабилизация статуса**: Статус инициализируется сразу в конструкторе

### Технические изменения
- Добавлено свойство `available` в базовую сущность
- Немедленная запись состояния в `async_added_to_hass`
- Проверка доступности метода `perform_maintenance` в кнопке
- Расширенное логирование для отладки

## [1.3.5] - 2025-06-16

### Упрощение и стабилизация
- **Удалены глобальные сенсоры**: Убраны проблемные глобальные сенсоры подсчета, которые вызывали ошибки
- **Исправлена кнопка обслуживания**: Улучшена регистрация и доступность кнопки
- **Добавлена отладочная информация**: Расширено логирование для диагностики проблем
- **Упрощена архитектура**: Оставлены только основные сущности (статус, дни, кнопка)

### Удаленные компоненты
- `global_sensors.py` - файл глобальных сенсоров
- `maintenance_overdue_count` - глобальный сенсор просроченных
- `maintenance_due_count` - глобальный сенсор требующих обслуживания

### Технические изменения
- Улучшена обработка ошибок в кнопке
- Добавлено свойство `available` для кнопки
- Убраны упоминания глобальных сенсоров из переводов

## [1.3.4] - 2025-06-16

### Критические исправления unique_id
- **Исправлены unique_id глобальных сенсоров**: Возвращены к оригинальным значениям `maintenance_overdue_count` и `maintenance_due_count`
- **Стабилизированы unique_id сущностей**: Теперь используется только entry_id для формирования стабильных идентификаторов
- **Исправлена совместимость**: Существующие сущности должны снова работать корректно

### Технические изменения
- Упрощено формирование unique_id в базовой сущности
- Убрана зависимость от имени компонента в unique_id
- Исправлены суффиксы для разных типов сущностей (_status, _days, _button)

## [1.3.3] - 2025-06-16

### Критические исправления
- **Восстановлены все сущности**: Возвращены сенсор дней до обслуживания и кнопка выполнения обслуживания
- **Исправлена функциональность**: Теперь при добавлении записи создаются все необходимые сущности (статус, дни, кнопка, глобальные сенсоры)
- **Исправлены переводы**: Добавлены недостающие переводы для всех сущностей

### Восстановленные сущности
- Сенсор статуса обслуживания (`*_status`)
- Сенсор дней до обслуживания (`*_days`) 
- Кнопка выполнения обслуживания (`*_perform_maintenance`)
- Глобальные сенсоры подсчета (`maintenance_overdue_count`, `maintenance_due_count`)

## [1.3.2] - 2025-06-16

### Изменения
- **Упрощено автоматическое обновление**: Убрана настройка интервала обновления, теперь сенсоры автоматически пересчитываются каждый день в полночь
- **Восстановлены глобальные сенсоры**: Добавлены обратно сенсоры подсчета просроченных и требующих обслуживания компонентов
- **Оптимизирован интерфейс**: Убраны лишние настройки из конфигурации, оставлены только необходимые

### Исправления
- Исправлена проблема с отсутствующими глобальными сенсорами после рефакторинга
- Упрощена логика обновления - теперь происходит автоматически без настроек пользователя

### Технические изменения
- Заменен `async_track_time_interval` на `async_track_time_change` для ежедневного обновления в 00:01
- Добавлен модуль `global_sensors.py` с восстановленными глобальными сенсорами
- Обновлены переводы для упрощенного интерфейса

## [1.3.1] - 2025-06-16

### Новые возможности
- **Автоматическое обновление**: Настраиваемые интервалы обновления от 5 минут до 24 часов
- **Система событий**: События `maintainable_overdue`, `maintainable_due`, `maintainable_completed`
- **Расширенные настройки**: Дополнительные опции в интерфейсе конфигурации
- **Умные уведомления**: Переключаемые уведомления о событиях

### Исправления безопасности и надежности
- **Валидация дат**: Предотвращение будущих дат и ограничение прошлых дат до 10 лет
- **Защита от race condition**: Использование `asyncio.Lock` для безопасного доступа к хранилищу сущностей
- **Предотвращение утечек памяти**: Правильная очистка таймеров в `async_will_remove_from_hass`
- **Улучшенная обработка ошибок**: Try/catch блоки во всех критических местах
- **Исправления часовых поясов**: Использование полудня (12:00) вместо полуночи

### Оптимизация производительности
- **Оптимизированный поиск сущностей**: Использование реестра сущностей Home Assistant
- **Удалены неэффективные циклы**: Убраны вложенные циклы в сервисах
- **Асинхронная система уведомлений**: Для обновления связанных сущностей
- **Кэширование и оптимизированные запросы**

### Новые файлы
- `EVENTS.md`: Документация по системе событий с примерами автоматизаций
- `global_sensors.py`: Восстановленные глобальные сенсоры (добавлено в 1.3.2)

## [1.3.0] - 2025-06-16

### Критические исправления
- **Исправлена ошибка инициализации**: Устранена `AttributeError: 'dict' object has no attribute '_global_sensors_created'`
- **Удален отсутствующий импорт**: Убран импорт несуществующего `template_sensor`
- **Восстановлена функциональность**: Интеграция снова работает корректно

### Комплексные улучшения
- **Автоматическое обновление состояний**: Сенсоры теперь обновляются автоматически
- **Система событий**: Отправка событий при изменении статуса обслуживания
- **Защита от race conditions**: Синхронизация доступа к общим ресурсам
- **Предотвращение утечек памяти**: Правильная очистка ресурсов
- **Валидация данных**: Проверка корректности дат и интервалов
- **Оптимизация производительности**: Улучшенные алгоритмы поиска и обновления

## [1.2.0] - 2025-06-16

### Новые возможности
- Добавлена кнопка "Установить дату обслуживания" для каждого компонента
- Улучшенная валидация дат с проверкой на будущие даты
- Расширенные сервисы для управления обслуживанием

### Исправления
- Исправлена обработка дат в сервисах
- Улучшена стабильность при обновлении состояний

## [1.1.0] - 2025-06-16

### Новые возможности
- Глобальные сенсоры подсчета просроченных и требующих обслуживания компонентов
- Сервис получения списка всех обслуживаемых компонентов
- Улучшенная система иконок в зависимости от статуса

### Улучшения
- Оптимизированы алгоритмы подсчета и обновления
- Добавлены подробные атрибуты к глобальным сенсорам

## [1.0.0] - 2025-06-16

### Первый релиз
- Базовая функциональность отслеживания обслуживания
- Сенсоры статуса и дней до обслуживания
- Кнопка выполнения обслуживания
- Сервис установки даты последнего обслуживания
- Поддержка привязки к устройствам
- Многоязычная поддержка (русский, английский)

### Техническое
- 🏗️ Базовая архитектура с наследованием MaintainableEntity
- 🔧 Config Flow для настройки через интерфейс
- 📝 Константы и типизация
- 🧪 GitHub Actions для валидации и релизов
- 📚 Подробная документация и README
- 🐛 Шаблоны для issue и bug reports

---

**Легенда:**
- ✨ Новые функции
- 🔧 Улучшения
- 🐛 Исправления ошибок
- 📚 Документация
- 🏗️ Техническое 